# NUTRIAI — README / ТЗ Mini‑App (Telegram)

> Рабочее название. Мини‑приложение Telegram для учёта питания по фото (Vision) и вручную (Premium), с целями по калориям и БЖУ, прогнозом веса и геймификацией. Архитектура: **Client — JavaScript (React)**, **Server — Python (FastAPI)**, **DB — Postgres**. Учёт/идентификация по **Telegram ID**.

---

## 1) Идея и ценность
- **Одна фотка — один результат**: пользователь делает фото блюда → ИИ определяет состав, порцию и рассчитывает **ккал/Б/Ж/У**.
- **Apple‑подход**: чистый интерфейс, минимум действий, мгновенная обратная связь, анимации, «невидимая» сложность.
- **Персонализация**: опрос по здоровью (вес, давление, диагнозы, активность) и цели (**похудение/поддержание/набор**). Дневная норма и рекомендации учитывают профиль.
- **Прогноз веса**: ежедневная оценка + недельный прогноз на основе дефицита/профицита.
- **Мотивация**: достижения, бейджи, лидерборд. 

---

## 2) Модель монетизации и подписок
**Freemium** (база):
- До **3 фото‑анализов в день** (Vision).
- Заполнение профиля и **постановка личных целей** (ккал/БЖУ).
- ✖️ Нет ручного ввода блюд, ✖️ нет социалки/лидерборда, ✖️ нет рекомендаций/замен, ✖️ нет еженедельного веса и продвинутой аналитики.

**Premium**:
- До **7 фото‑анализов в день** (Vision).
- **Ручной ввод** блюд (поиск/автодополнение, штрих‑коды — опц.).
- **Еженедельное взвешивание** и сравнение с ИИ‑прогнозом (сценарии «забывал/сжульничал»).
- **Рекомендации замен**: менее/более калорийные и белковые альтернативы.
- **Учёт активности** (импорт/ввод) — корректировка дневной цели.
- **Достижения/бейджи**, **лидерборд**, **просмотр чужих профилей** (с приватностью).
- (Опц. Premium+) **ИИ‑план меню на неделю** + **список покупок**, импорт рецептов/ссылок.

> Все лимиты и статусы подписки хранятся в Postgres. Ключ учёта — **Telegram ID**. Дата окончания проверяется в middleware на каждом запросе.

---

## 3) Пользовательские флоу
### 3.1 Онбординг
1. **Telegram WebApp Login** → подтягиваем аватар/имя (initData).
2. Модалка **опроса здоровья** (редактируемо в Профиле): пол, возраст, рост, вес, целевой вес, активность, давление, диагнозы (напр. диабет), чувствительности к продуктам.
3. Выбор цели (**похудение/поддержание/набор**). 
4. Расчёт **BMR (Mifflin–St Jeor)** → **TDEE** → корректировка под цель и профиль. 
5. Установка **недельных/месячных целей** по ккал/БЖУ. Сохранение в БД.

### 3.2 Учёт питания (дневной цикл)
- **Фото** → Vision‑анализ → карточка блюда: ккал/Б/Ж/У, уверенность, ползунок «порция» (½, ⅓ и т.п.) → «Добавить».
- (Premium) **Ручной ввод**: быстрый поиск по базе блюд, сохранённые «быстрые блюда», скан штрих‑кода (опц.).
- Экран «Сегодня»: **кольца Ккал/Б/Ж/У**, список приёмов пищи, индикатор попадания в цель.

### 3.3 Прогноз веса и еженедельная проверка (Premium)
- Ежедневно: рассчёт **дефицит/профицит** = Поступление − (TDEE + Активность). 
- Перевод в массу (≈ 7 700 ккал ≈ 1 кг) + сглаживание **EWMA**.
- Раз в неделю модалка «**Введите вес**». Если сильное отклонение от прогноза:
  - «**Забывал вносить**» → включаем мягкие напоминания/модалки при открытии.
  - «**Сжульничал**» → анализ перерасхода/недобора, советы замен/план «анти‑срыв».

### 3.4 Социалка (Premium)
- Профили по Telegram ID: аватар, имя, бейджи, краткий статус.
- **Приватность**: показать/скрыть вес, возраст, здоровье.
- **Лидерборд** (топ‑15) и переходы в профили.

---

## 4) Алгоритмы и логика
### 4.1 Дневная норма
  - Мужчины: `10*вес + 6.25*рост – 5*возраст + 5`
  - Женщины: `10*вес + 6.25*рост – 5*возраст – 161`
- Учёт профиля здоровья (напр., диабет → лимиты быстрых углеводов, гипертония → натрий и т.д.).

2) Оценка порции (геометрия/референсы/уточняющий диалог).
3) Сопоставление с нутри‑базой → расчёт ккал/Б/Ж/У.
```
Сцена: фото блюда пользователя. Определи блюда и примерные порции. Верни JSON:
  ]
}
Только JSON без комментариев.

### 4.3 Прогноз веса
- День: `delta_kcal = intake_kcal - (tdee + activity_kcal)`

### 4.4 Лидерборд (топ‑15)
  - 30% — **попадание в цель** (ккал/БЖУ в допуске ±5–10%).
  - 20% — **прогресс к цели** (безопасная динамика, анти‑экстрим).
---

- **Светлая/тёмная тема**, плотность 8‑pt grid, большие тач‑таргеты (≥ 44 px).
- Контраст, читаемость, лаконичность, «воздух»; анимации — быстрые, информативные.
- **Сегодня**: три кольца (Ккал/Б/Ж/У), под ними список приёмов, FAB «Камера».
- **Камера/Фото**: лайв‑индикатор анализа, скелетоны карточек, быстрая корректировка порций.
- **Профиль**: аватар из Telegram, бейджи, переключатели приватности.
- **Лидерборд** (Premium): топ‑15, мини‑карточки с индексом устойчивости.

### 5.3 Компоненты и анимации
- Карточки с мягкими тенями, стеклянные блюры (умеренно), пружинные переходы.
- Skeleton‑лоадеры, «liquid swipe», прогресс‑кольца с плавным перетеканием.
- Состояния: loading / success / warning / error (иконки + подсказки).

### 5.4 Открытие вне Telegram
- Если в обычном браузере → минималистичный лендинг с CTA **«Открыть в Telegram»** (deep‑link `t.me/<bot>?startapp=...`).

---

## 6) Архитектура и репозиторий
```
  client/                 # JS (React)
  server/                 # Python (FastAPI)
  README.md
См. подробности по структуре в проекте.

**Пользователь/подписка**
- `subscriptions(user_id FK, tier ENUM('free','premium'), expires_at)`


- `food_entries(id, user_id FK, date, source ENUM('photo','manual'), kcal, protein, fat, carb, meal_type, portion_ratio, meta jsonb)`
- `photo_analyses(id, user_id FK, s3_key, detected_items jsonb, confidence, status, created_at)`
- `achievements(user_id FK, code, earned_at)`
- `social_edges(follower_id FK, followee_id FK)`
- `leaderboard_snapshots(id, week_start, user_id FK, score)`


## 8) API (черновой контракт)
**Профиль/здоровье/цели**
- `GET /goals` / `PUT /goals`

- `POST /entry/manual` (Premium)
**Вес/сводки**
- `POST /weight`  
- `GET /profile/{tg_id}` (с приватностью)  
- `GET /achievements`

```
{
  "date": "2025-09-03",
  "activity_kcal": 320,
  "est_weight_kg": 78.6
}
```


## 9) Middleware и ограничения
- Проверка `tier` и `expires_at` для доступа к Premium‑эндпоинтам.
- Дневные лимиты Vision: **3/7** в зависимости от тарифа (сброс в 00:00 локально или по UTC, настраиваемо).

## 10) Интеграции активности
- **Google Fit / Strava / Garmin** (OAuth) — опционально.
- Для Apple Health — Shortcut/ручной импорт. Внутри Mini‑App — понятные инструкции.
- Всегда доступен **ручной ввод** активности в ккал (Premium).

---

## 11) Уведомления и сценарии «забывал/сжульничал»
- Через Telegram‑бота: еженедельное взвешивание, добрые напоминания, контекстные советы.
- «Забывал» → пин‑модалка при открытии до фиксации 2–3 приёмов.
- «Сжульничал» → предложить альтернативы, баланс на завтра, мягкая мотивация.

---

## 12) Безопасность и приватность
- **Верификация Telegram initData** (HMAC SHA‑256) на каждом запуске WebApp.
- Минимальный сбор PII, настройка приватности профиля по умолчанию «закрыто».
- Дисклеймер: не медицинское приложение; границы безопасных рекомендаций.
- Логи и аудит доступа, защита файлами/ролями.

---

## 13) Аналитика и метрики
- Retention D1/D7/D30, среднее кол‑во анализов/день, CR в Premium, конверсия онбординга, причинный опрос churn.
- Точность Vision (human‑in‑the‑loop правки порций), средняя ошибка прогноза веса.

---

## 14) Тестирование
- **Unit**: расчёт норм, EWMA, лимиты, лидерборд.
- **E2E** (Playwright): онбординг → фото → добавление блюда → пересчёт колец.
- **Нагрузочные**: очередь Vision, пик‑часы.
- **UX‑тесты**: время до первой полезной метрики, ошибки ввода порций.

---

## 15) Деплой и окружение
- **Docker‑compose**: `web` (client build + static), `api` (FastAPI + Uvicorn), `db` (Postgres), `redis/rabbit` (Celery), `minio` (S3‑хранилище).
- **ENV (пример)**: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_WEBAPP_HASH_KEY`, `DATABASE_URL`, `S3_ACCESS_KEY`, `S3_SECRET_KEY`, `VISION_MODEL_KEY`, `JWT_SECRET`.
- **CI/CD**: линтеры, тесты, сборка клиента, миграции Alembic, выкладка.

---

## 16) Roadmap
- **MVP**: auth, анкета, нормы, фото‑анализ (1 блюдо), лимиты 3/7, «Сегодня», базовый прогноз, Premium‑покупка, профиль, напоминания.
- **V2**: многоблюдность на фото, ручной ввод, еженедельный вес + сценарии, достижения, лидерборд.
- **V3**: импорт активности, штрих‑коды, импорт рецептов, ИИ‑план меню + список покупок, челленджи.

---

## 17) Риски и как их снизить
- **Точность порций** → добавляем быстрые корректоры и эталон‑референсы.
- **Ограничения Vision API** → очередь/ретраи/кэш, смешанный пайплайн (классическая детекция + LLM‑подсказки).
- **Приватность** → по умолчанию закрытый профиль, явные тумблеры видимости.
- **Онбординг friction** → прогрессивный сбор данных, «доскажете позже».

---

## 18) UI‑копирайт (примеры коротких текстов)
- «Ещё шаг — и кольца закроются!»
- «Не попали в белки сегодня? Вот 3 простых варианта ужина»
- «Взвесимся в воскресенье — сверим курс к цели»

---

## 19) Легко заменить нейминг/брендинг
Название, цвета, иконки, тон сообщений — вынести в конфиг дизайн‑системы.

---

**Готово к детализации**: при необходимости добавим ER‑диаграммы, схемы очередей, OpenAPI‑спеки и шаблоны кода (client/server).

---

## 21) Automation / Tasks

VS Code Tasks (added):
- backend:dev – Uvicorn reload
- frontend:dev – Vite dev server

Recommended additions (compound):
```jsonc
// .vscode/tasks.json (пример)
{
  "version": "2.0.0",
  "tasks": [
    { "label": "backend:dev", "type":"shell", "command":"uvicorn backend.main:app --reload --port 8000", "group":"build" },
    { "label": "frontend:dev", "type":"shell", "command":"cd frontend && npm run dev", "group":"build" },
    { "label": "full:dev", "dependsOn":["backend:dev","frontend:dev"], "dependsOrder":"parallel" }
  ]
}
```

Bootstrap (PowerShell):
```powershell
python -m venv .venv
./.venv/Scripts/Activate.ps1
pip install -r backend/requirements.txt
cd frontend; npm install; cd ..
code .
```

Run dev servers:
```powershell
# VS Code: Ctrl+Shift+P → Run Task → full:dev (если добавлен)
# или отдельно:
uvicorn backend.main:app --reload --port 8000
cd frontend; npm run dev
```

Future CI (GitHub Actions outline):
1. Setup Python + cache deps
2. pip install -r backend/requirements.txt
3. (Later) pytest / mypy
4. Setup Node + cache
5. npm ci && npm run build (frontend)
6. Copy dist/ into backend image layer (Docker multi-stage)
7. Push image / deploy

Makefile alternative (Linux/macOS):
```makefile
dev: backend frontend

backend:
	uvicorn backend.main:app --reload --port 8000

frontend:
	cd frontend && npm run dev
```

